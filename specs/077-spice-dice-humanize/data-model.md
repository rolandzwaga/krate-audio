# Data Model: Spice/Dice & Humanize

**Feature**: 077-spice-dice-humanize | **Date**: 2026-02-23

## Entities

### 1. Variation Overlay (ArpeggiatorCore members)

Four parallel arrays storing random values generated by the Dice trigger. Blended with original lane values using the Spice amount.

| Field | Type | Range | Default | Description |
|---|---|---|---|---|
| `velocityOverlay_` | `std::array<float, 32>` | [0.0, 1.0] | 1.0 (all entries) | Velocity scaling overlay |
| `gateOverlay_` | `std::array<float, 32>` | [0.0, 1.0] | 1.0 (all entries) | Gate scaling overlay |
| `ratchetOverlay_` | `std::array<uint8_t, 32>` | [1, 4] | 1 (all entries) | Ratchet count overlay |
| `conditionOverlay_` | `std::array<uint8_t, 32>` | [0, 17] | 0/Always (all entries) | TrigCondition overlay |

**Total memory**: 4 x 32 bytes (float arrays) + 2 x 32 bytes (uint8_t arrays) = 320 bytes. Fixed, no allocation.

**Lifecycle**:
- Initialized to identity values in constructor (FR-002)
- Regenerated by `triggerDice()` (FR-005)
- NOT reset by `reset()` or `resetLanes()` (FR-025)
- NOT serialized in plugin state (FR-030)
- Revert to defaults on preset load (identity values from default-constructed `ArpeggiatorParams`)

### 2. Spice Amount (ArpeggiatorCore member)

| Field | Type | Range | Default | Description |
|---|---|---|---|---|
| `spice_` | `float` | [0.0, 1.0] | 0.0 | Blend ratio: 0=original, 1=overlay |

**Setter**: `setSpice(float value)` with `std::clamp(value, 0.0f, 1.0f)`
**Getter**: `spice()` const

**Lifecycle**:
- Set by `applyParamsToEngine()` from atomic `arpParams_.spice`
- NOT reset by `reset()` or `resetLanes()` (FR-026)
- Serialized in plugin state (FR-037)

### 3. Humanize Amount (ArpeggiatorCore member)

| Field | Type | Range | Default | Description |
|---|---|---|---|---|
| `humanize_` | `float` | [0.0, 1.0] | 0.0 | Offset magnitude: 0=quantized, 1=max variation |

**Setter**: `setHumanize(float value)` with `std::clamp(value, 0.0f, 1.0f)`
**Getter**: `humanize()` const

**Lifecycle**:
- Set by `applyParamsToEngine()` from atomic `arpParams_.humanize`
- NOT reset by `reset()` or `resetLanes()` (FR-027)
- Serialized in plugin state (FR-037)

### 4. Spice/Dice PRNG (ArpeggiatorCore member)

| Field | Type | Seed | Description |
|---|---|---|---|
| `spiceDiceRng_` | `Xorshift32` | 31337 | Generates overlay values in `triggerDice()` |

**Lifecycle**:
- Constructed with seed 31337 (FR-005)
- Advanced 128 times per `triggerDice()` call (32 per lane x 4 lanes)
- NOT reset by `reset()` or `resetLanes()` (FR-029)
- NOT serialized

### 5. Humanize PRNG (ArpeggiatorCore member)

| Field | Type | Seed | Description |
|---|---|---|---|
| `humanizeRng_` | `Xorshift32` | 48271 | Generates per-step random offsets |

**Lifecycle**:
- Constructed with seed 48271 (FR-013)
- Advanced 3 times per step (timing, velocity, gate) regardless of whether step fires (FR-018, FR-023)
- NOT reset by `reset()` or `resetLanes()` (FR-028)
- NOT serialized

### 6. Plugin Atomic Storage (ArpeggiatorParams members)

| Field | Type | Default | VST3 Param ID | Description |
|---|---|---|---|---|
| `spice` | `std::atomic<float>` | 0.0f | kArpSpiceId = 3290 | Spice blend amount |
| `diceTrigger` | `std::atomic<bool>` | false | kArpDiceTriggerId = 3291 | Dice trigger flag (edge-detected) |
| `humanize` | `std::atomic<float>` | 0.0f | kArpHumanizeId = 3292 | Humanize amount |

## Relationships

```
ArpeggiatorParams (plugin thread)
    |
    | std::atomic (lock-free)
    v
applyParamsToEngine() (audio thread, per-block)
    |
    +-- setSpice(spice.load()) --> spice_ member
    |
    +-- compare_exchange_strong(diceTrigger) --> triggerDice()
    |       |
    |       +-- spiceDiceRng_.nextUnipolar() x64 --> velocityOverlay_[0..31], gateOverlay_[0..31]
    |       +-- spiceDiceRng_.next() x64 --> ratchetOverlay_[0..31], conditionOverlay_[0..31]
    |
    +-- setHumanize(humanize.load()) --> humanize_ member
```

```
fireStep() (audio thread, per-step)
    |
    +-- Capture overlay indices (velStep, gateStep, ratchetStep, condStep)
    |
    +-- Lane advances (unchanged)
    |
    +-- Spice blend (if spice_ > 0):
    |       velScale = lerp(velScale, velocityOverlay_[velStep], spice_)
    |       gateScale = lerp(gateScale, gateOverlay_[gateStep], spice_)
    |       ratchetCount = round(lerp(ratchetCount, ratchetOverlay_[ratchetStep], spice_))
    |       condValue = spice_ >= 0.5 ? conditionOverlay_[condStep] : condValue
    |
    +-- [Existing: Euclidean, Condition, Modifier evaluation]
    |
    +-- Humanize offsets (3 PRNG calls always consumed):
    |       timingOffset = humanizeRng_.nextFloat() * maxTimingSamples * humanize_
    |       velocityOffset = humanizeRng_.nextFloat() * 15 * humanize_
    |       gateOffsetRatio = humanizeRng_.nextFloat() * 0.10 * humanize_
    |
    +-- Note emission at humanized sample offset
```

## Validation Rules

| Rule | Applies To | Formula |
|---|---|---|
| Spice range | `spice_` | `std::clamp(value, 0.0f, 1.0f)` |
| Humanize range | `humanize_` | `std::clamp(value, 0.0f, 1.0f)` |
| Velocity clamp | Post-humanize velocity | `std::clamp(vel, 1, 127)` |
| Timing clamp | Post-humanize sample offset | `std::clamp(offset, 0, blockSize - 1)` |
| Gate minimum | Post-humanize gate duration | `std::max(int32_t{1}, duration)` |
| Ratchet range | Post-Spice ratchet count | `std::clamp(count, 1, 4)` |
| Condition range | Dice overlay values | `next() % 18` (TrigCondition::kCount) |
| Ratchet overlay range | Dice overlay values | `next() % 4 + 1` |

## State Transitions

### Overlay State Machine

```
[Identity] --triggerDice()--> [Random A] --triggerDice()--> [Random B] --...
     ^                           |                              |
     |                           | (not affected by reset/      |
     |                           |  resetLanes/transport)       |
     |                           |                              |
     +------ preset load --------+--------- preset load --------+
     (overlays revert to identity on load since NOT serialized)
```

### Humanize PRNG State

```
[Seed 48271] --step 0--> [state A] --step 1--> [state B] --...
                           (3 calls)              (3 calls)

Note: NOT reset on reset(), resetLanes(), or transport restart.
PRNG continues advancing to prevent repeating humanize patterns.
```

## Serialization Format

Appended after Phase 8's `fillToggle` (int32):

| Order | Field | Type | Size | Notes |
|---|---|---|---|---|
| N+1 | spice | float | 4 bytes | [0.0, 1.0] |
| N+2 | humanize | float | 4 bytes | [0.0, 1.0] |

Total new serialization: 8 bytes. If EOF at field N+1 read, assume Phase 8 preset (defaults apply). If field N+1 present but N+2 missing, stream is corrupt (return false).

diceTrigger and overlay arrays are NOT serialized (FR-030, FR-037).
