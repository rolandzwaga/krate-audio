# Implementation Plan: Biquad Filter Primitive

**Branch**: `004-biquad-filter` | **Date**: 2025-12-22 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-biquad-filter/spec.md`

---

## Summary

Implement a Layer 1 Biquad Filter primitive providing second-order IIR filtering with Transposed Direct Form II topology. The filter supports 8 filter types (LP, HP, BP, Notch, Allpass, LowShelf, HighShelf, Peak), cascading for steeper slopes, and smoothed coefficient updates. This is the foundation for all frequency-shaping operations in Layer 2+ components.

---

## Technical Context

**Language/Version**: C++20 (MSVC 2019+, Clang 12+, GCC 10+)
**Primary Dependencies**: None external; uses project's dsp_utils.h (OnePoleSmoother, kPi, kTwoPi)
**Storage**: N/A (stateful filter with 2 state variables per stage)
**Testing**: Catch2 (existing test infrastructure) *(Constitution Principle XII: Test-First Development)*
**Target Platform**: Windows x64, macOS x64/ARM64, Linux x64
**Project Type**: Single project (DSP library component)
**Performance Goals**: < 0.1% CPU per filter instance at 44.1kHz stereo (Constitution Principle XI)
**Constraints**: Real-time safe (no allocation, no locks, no exceptions), denormal handling
**Scale/Scope**: Single biquad stage + BiquadCascade utility for multi-stage filtering

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Requirement | Status |
|-----------|-------------|--------|
| **II. Real-Time Audio Thread Safety** | No allocation, locks, or blocking in process() | COMPLIANT - Header-only, stack-based state |
| **III. Modern C++ Standards** | RAII, constexpr, noexcept | COMPLIANT - Pure functions, constexpr coefficients |
| **IV. SIMD & DSP Optimization** | Contiguous memory, minimal branching | COMPLIANT - Sample-by-sample with optional block |
| **VIII. Testing Discipline** | Unit tests for all DSP algorithms | WILL COMPLY - Test-first workflow |
| **IX. Layered Architecture** | Layer 1 depends only on Layer 0 | COMPLIANT - Only uses dsp_utils.h (Layer 0) |
| **X. DSP Processing Constraints** | TDF2, stability validation | COMPLIANT - Using recommended topology |
| **XI. Performance Budgets** | < 0.1% CPU per primitive | WILL VERIFY - Benchmark tests |
| **XII. Test-First Development** | Tests before implementation | WILL COMPLY - Explicit todo items |

**Required Check - Principle XII (Test-First Development):**
- [x] Tasks will include TESTING-GUIDE.md context verification step
- [x] Tests will be written BEFORE implementation code
- [x] Each task group will end with a commit step

---

## Project Structure

### Documentation (this feature)

```text
specs/004-biquad-filter/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Coefficient formulas & best practices
├── data-model.md        # Filter structures and types
├── quickstart.md        # Usage examples
├── contracts/           # API contracts
│   └── biquad.h         # Public interface definition
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── dsp/
│   ├── core/
│   │   └── db_utils.h          # Layer 0: dB conversion (existing)
│   ├── primitives/
│   │   ├── delay_line.h        # Layer 1: DelayLine (existing)
│   │   ├── lfo.h               # Layer 1: LFO (existing)
│   │   └── biquad.h            # Layer 1: Biquad filter (NEW)
│   └── dsp_utils.h             # Shared utilities (existing)

tests/
├── unit/
│   ├── primitives/
│   │   ├── delay_line_test.cpp # Existing
│   │   ├── lfo_test.cpp        # Existing
│   │   └── biquad_test.cpp     # NEW
│   └── core/
│       └── db_utils_test.cpp   # Existing
└── regression/
    └── approved/               # Approval test baselines
```

**Structure Decision**: Following existing Layer 1 primitive pattern established by delay_line.h and lfo.h. Header-only implementation in `src/dsp/primitives/biquad.h` with unit tests in `tests/unit/primitives/biquad_test.cpp`.

---

## Complexity Tracking

No constitution violations requiring justification.

---

## Research Summary

See [research.md](research.md) for detailed analysis.

**Key Decisions:**
1. **Topology**: Transposed Direct Form II (best for floating-point, recommended by constitution)
2. **Coefficient Formulas**: Robert Bristow-Johnson's Audio EQ Cookbook (industry standard)
3. **Smoothing Strategy**: Per-coefficient smoothing using existing OnePoleSmoother
4. **Denormal Handling**: Flush state to zero when below threshold (1e-15)
5. **Constexpr Math**: Custom Taylor series for sin/cos (MSVC compatibility)

---

## Design Artifacts

| Artifact | Purpose | Location |
|----------|---------|----------|
| research.md | Coefficient formulas, topology analysis | [research.md](research.md) |
| data-model.md | FilterType enum, Biquad class structure | [data-model.md](data-model.md) |
| contracts/biquad.h | Public API definition | [contracts/biquad.h](contracts/biquad.h) |
| quickstart.md | Usage examples | [quickstart.md](quickstart.md) |
