name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  # ccache settings (used by Linux and macOS builds)
  CCACHE_MAXSIZE: 500M
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6

jobs:
  build-windows:
    name: Windows (MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setup MSVC environment for Ninja (otherwise it finds MinGW)
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # Setup sccache for compiler caching
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      # Use Ninja with sccache for faster builds
      # The /Zi -> /Z7 workaround in CMakeLists.txt enables PDB-free compilation
      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_C_COMPILER_LAUNCHER=sccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build Tests
        run: cmake --build build --target dsp_tests approval_tests vst_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      # Show sccache statistics for debugging cache effectiveness
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Windows-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn

  build-macos:
    name: macOS (Clang)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install ccache for compiler caching
      - name: Install ccache
        run: brew install ccache

      # Setup ccache with GitHub Actions cache backend
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos-xcode-${{ env.BUILD_TYPE }}
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      # Use Xcode generator with ccache via TheLartians/Ccache.cmake wrapper scripts
      # This works around Xcode ignoring CMAKE_<LANG>_COMPILER_LAUNCHER
      - name: Configure CMake
        run: cmake -S . -B build -G Xcode -DUSE_CCACHE=ON

      - name: Build Tests
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target dsp_tests approval_tests vst_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      # Show ccache statistics for debugging cache effectiveness
      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-macOS
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn

  # Linux build (optional per constitution - Platform Support Matrix)
  build-linux:
    name: Linux (GCC)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache apt packages
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: >-
            ninja-build libx11-dev libxcb1-dev libxkbcommon-x11-dev libx11-xcb-dev
            libxcb-util1 libxcb-util-dev libxcb-keysyms1-dev libxcb-cursor-dev
            libxcb-xkb-dev libxkbcommon-dev libfontconfig1-dev libfreetype6-dev
            libcairo2-dev libgtkmm-3.0-dev libsqlite3-dev
          version: 1.0

      # Cache ccache data
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-gcc-${{ env.BUILD_TYPE }}
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build Tests
        run: cmake --build build --target dsp_tests approval_tests vst_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Linux-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn
