name: CI

on:
  push:
    branches: [main]
    paths:
      - 'dsp/**'
      - 'plugins/**'
      - 'tests/**'
      - 'extern/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'dsp/**'
      - 'plugins/**'
      - 'tests/**'
      - 'extern/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/ci.yml'
  workflow_call:
    # Allows this workflow to be called by release.yml

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  # ccache settings (used by Linux and macOS builds)
  CCACHE_MAXSIZE: 500M
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6

jobs:
  build-windows:
    name: Windows (MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache CMake FetchContent downloads (key includes 'vs' to avoid Ninja cache conflicts)
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-vs-${{ hashFiles('CMakeLists.txt', 'dsp/CMakeLists.txt', 'plugins/iterum/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-vs-

      # Note: sccache/ccache with Ninja causes PDB conflicts with VSTGUI's /Zi flag
      # Visual Studio generator handles PDB files correctly via mspdbsrv.exe
      - name: Configure CMake
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build Tests
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target dsp_tests plugin_tests approval_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Windows-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn

  build-macos:
    name: macOS (Clang)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install ccache for compiler caching
      - name: Install ccache
        run: brew install ccache

      # Setup ccache with GitHub Actions cache backend
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos-xcode-${{ env.BUILD_TYPE }}
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'dsp/CMakeLists.txt', 'plugins/iterum/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      # Use Xcode generator with ccache via TheLartians/Ccache.cmake wrapper scripts
      # This works around Xcode ignoring CMAKE_<LANG>_COMPILER_LAUNCHER
      # Note: PCH stays enabled on macOS - ccache handles it better than sccache
      # Note: SMTG_ENABLE_AUV2_BUILDS enables Audio Unit v2 build via VST3 SDK AU wrapper
      # Note: SMTG_CODE_SIGN_IDENTITY_MAC="-" uses ad-hoc signing (no keychain required in CI)
      - name: Configure CMake
        run: cmake -S . -B build -G Xcode -DUSE_CCACHE=ON -DSMTG_ENABLE_AUV2_BUILDS=ON -DSMTG_CODE_SIGN_IDENTITY_MAC="-"

      - name: Build Tests
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target dsp_tests plugin_tests approval_tests --parallel

      - name: Build Plugin, AU, and Validator
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Iterum Iterum_AU validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      # Install AU and run auval validation
      - name: Run AU Validation
        run: |
          mkdir -p ~/Library/Audio/Plug-Ins/Components
          rm -rf ~/Library/Audio/Plug-Ins/Components/Iterum.component
          cp -R build/VST3/${{ env.BUILD_TYPE }}/Iterum.component ~/Library/Audio/Plug-Ins/Components/
          killall -9 AudioComponentRegistrar 2>/dev/null || true
          sleep 2
          auval -v aufx Itrm KrAt

      # Show ccache statistics for debugging cache effectiveness
      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      - name: Upload Plugin Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-macOS
          path: |
            build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
            build/VST3/${{ env.BUILD_TYPE }}/Iterum.component
          if-no-files-found: warn

  # Linux build (optional per constitution - Platform Support Matrix)
  build-linux:
    name: Linux (GCC)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache apt packages
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: >-
            ninja-build libx11-dev libxcb1-dev libxkbcommon-x11-dev libx11-xcb-dev
            libxcb-util1 libxcb-util-dev libxcb-keysyms1-dev libxcb-cursor-dev
            libxcb-xkb-dev libxkbcommon-dev libfontconfig1-dev libfreetype6-dev
            libcairo2-dev libgtkmm-3.0-dev libsqlite3-dev
          version: 1.0

      # Cache ccache data
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-gcc-${{ env.BUILD_TYPE }}
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'dsp/CMakeLists.txt', 'plugins/iterum/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      # Note: PCH stays enabled on Linux - ccache handles it, and VSTGUI has
      # a missing #include <string> bug that only manifests when PCH is disabled
      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build Tests
        run: cmake --build build --target dsp_tests plugin_tests approval_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      # Show ccache statistics for debugging cache effectiveness
      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Linux-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn
