name: CI

on:
  push:
    branches: [main]
    paths:
      - 'dsp/**'
      - 'plugins/**'
      - 'tests/**'
      - 'extern/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'dsp/**'
      - 'plugins/**'
      - 'tests/**'
      - 'extern/**'
      - 'CMakeLists.txt'
      - 'CMakePresets.json'
      - '.github/workflows/ci.yml'
  workflow_call:
    # Allows this workflow to be called by release.yml

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  # ccache settings (used by Linux and macOS builds)
  CCACHE_MAXSIZE: 500M
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6

jobs:
  # Detect which parts of the codebase changed to run targeted tests
  # When called via workflow_call (e.g., from release.yml), run all tests
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      dsp: ${{ steps.set-outputs.outputs.dsp }}
      iterum: ${{ steps.set-outputs.outputs.iterum }}
      disrumpo: ${{ steps.set-outputs.outputs.disrumpo }}
      infra: ${{ steps.set-outputs.outputs.infra }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect file changes
        if: github.event_name != 'workflow_call'
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dsp:
              - 'dsp/**'
            iterum:
              - 'plugins/iterum/**'
            disrumpo:
              - 'plugins/disrumpo/**'
            infra:
              - 'tests/**'
              - 'extern/**'
              - 'CMakeLists.txt'
              - 'CMakePresets.json'
              - '.github/workflows/ci.yml'

      # Set outputs: use filter results for push/PR, run all for workflow_call
      - name: Set outputs
        id: set-outputs
        run: |
          if [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "dsp=true" >> $GITHUB_OUTPUT
            echo "iterum=true" >> $GITHUB_OUTPUT
            echo "disrumpo=true" >> $GITHUB_OUTPUT
            echo "infra=true" >> $GITHUB_OUTPUT
          else
            echo "dsp=${{ steps.filter.outputs.dsp }}" >> $GITHUB_OUTPUT
            echo "iterum=${{ steps.filter.outputs.iterum }}" >> $GITHUB_OUTPUT
            echo "disrumpo=${{ steps.filter.outputs.disrumpo }}" >> $GITHUB_OUTPUT
            echo "infra=${{ steps.filter.outputs.infra }}" >> $GITHUB_OUTPUT
          fi

  build-windows:
    name: Windows (MSVC)
    runs-on: windows-latest
    needs: detect-changes

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache CMake FetchContent downloads
      # Key includes repo name to prevent cache pollution after repo rename
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ github.repository }}-${{ runner.os }}-vs-${{ hashFiles('CMakeLists.txt', 'dsp/CMakeLists.txt', 'plugins/iterum/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ github.repository }}-${{ runner.os }}-vs-

      # Note: sccache/ccache with Ninja causes PDB conflicts with VSTGUI's /Zi flag
      # Visual Studio generator handles PDB files correctly via mspdbsrv.exe
      - name: Configure CMake
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build DSP Tests
        if: needs.detect-changes.outputs.dsp == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target dsp_tests --parallel

      - name: Build Iterum Tests
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target plugin_tests approval_tests --parallel

      - name: Build Iterum and Validator
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Iterum validator --parallel

      - name: Build Disrumpo
        if: needs.detect-changes.outputs.disrumpo == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Disrumpo --parallel

      - name: Run DSP Tests
        if: needs.detect-changes.outputs.dsp == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "dsp_tests"

      - name: Run Iterum Tests
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "plugin_tests|approval_tests"

      - name: Run VST3 Validator (Iterum)
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      - name: Upload Iterum Artifact
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Windows-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn

      - name: Upload Disrumpo Artifact
        if: needs.detect-changes.outputs.disrumpo == 'true' || needs.detect-changes.outputs.infra == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Disrumpo-Windows-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Disrumpo.vst3
          if-no-files-found: warn

  build-macos:
    name: macOS (Clang)
    runs-on: macos-latest
    needs: detect-changes

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install ccache for compiler caching
      - name: Install ccache
        run: brew install ccache

      # Setup ccache with GitHub Actions cache backend
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos-xcode-${{ env.BUILD_TYPE }}
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # Cache CMake FetchContent downloads
      # Key includes repo name to prevent cache pollution after repo rename
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ github.repository }}-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'dsp/CMakeLists.txt', 'plugins/iterum/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ github.repository }}-${{ runner.os }}-

      # Use Xcode generator with ccache via TheLartians/Ccache.cmake wrapper scripts
      # This works around Xcode ignoring CMAKE_<LANG>_COMPILER_LAUNCHER
      # Note: PCH stays enabled on macOS - ccache handles it better than sccache
      # Note: SMTG_ENABLE_AUV2_BUILDS enables Audio Unit v2 build via VST3 SDK AU wrapper
      # Note: SMTG_CODE_SIGN_IDENTITY_MAC="-" uses ad-hoc signing (no keychain required in CI)
      - name: Configure CMake
        run: cmake -S . -B build -G Xcode -DUSE_CCACHE=ON -DSMTG_ENABLE_AUV2_BUILDS=ON -DSMTG_CODE_SIGN_IDENTITY_MAC="-"

      - name: Build DSP Tests
        if: needs.detect-changes.outputs.dsp == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target dsp_tests --parallel

      - name: Build Iterum Tests
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target plugin_tests approval_tests --parallel

      - name: Build Iterum, AU, and Validator
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Iterum Iterum_AU validator --parallel

      - name: Build Disrumpo and AU
        if: needs.detect-changes.outputs.disrumpo == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Disrumpo Disrumpo_AU --parallel

      - name: Run DSP Tests
        if: needs.detect-changes.outputs.dsp == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "dsp_tests"

      - name: Run Iterum Tests
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "plugin_tests|approval_tests"

      - name: Run VST3 Validator (Iterum)
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      # Install AU and run auval validation for Iterum
      - name: Run Iterum AU Validation
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: |
          mkdir -p ~/Library/Audio/Plug-Ins/Components
          rm -rf ~/Library/Audio/Plug-Ins/Components/Iterum.component
          cp -R build/VST3/${{ env.BUILD_TYPE }}/Iterum.component ~/Library/Audio/Plug-Ins/Components/
          killall -9 AudioComponentRegistrar 2>/dev/null || true
          sleep 2
          auval -v aufx Itrm KrAt

      # Install AU and run auval validation for Disrumpo
      - name: Run Disrumpo AU Validation
        if: needs.detect-changes.outputs.disrumpo == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: |
          mkdir -p ~/Library/Audio/Plug-Ins/Components
          rm -rf ~/Library/Audio/Plug-Ins/Components/Disrumpo.component
          cp -R build/VST3/${{ env.BUILD_TYPE }}/Disrumpo.component ~/Library/Audio/Plug-Ins/Components/
          killall -9 AudioComponentRegistrar 2>/dev/null || true
          sleep 2
          auval -v aufx Dsrm KrAt

      # Show ccache statistics for debugging cache effectiveness
      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      - name: Upload Iterum Artifacts
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-macOS
          path: |
            build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
            build/VST3/${{ env.BUILD_TYPE }}/Iterum.component
          if-no-files-found: warn

      - name: Upload Disrumpo Artifacts
        if: needs.detect-changes.outputs.disrumpo == 'true' || needs.detect-changes.outputs.infra == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Disrumpo-macOS
          path: |
            build/VST3/${{ env.BUILD_TYPE }}/Disrumpo.vst3
            build/VST3/${{ env.BUILD_TYPE }}/Disrumpo.component
          if-no-files-found: warn

  # Linux build (optional per constitution - Platform Support Matrix)
  build-linux:
    name: Linux (GCC)
    runs-on: ubuntu-latest
    needs: detect-changes

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache apt packages
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: >-
            ninja-build libx11-dev libxcb1-dev libxkbcommon-x11-dev libx11-xcb-dev
            libxcb-util1 libxcb-util-dev libxcb-keysyms1-dev libxcb-cursor-dev
            libxcb-xkb-dev libxkbcommon-dev libfontconfig1-dev libfreetype6-dev
            libcairo2-dev libgtkmm-3.0-dev libsqlite3-dev
          version: 1.0

      # Cache ccache data
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-gcc-${{ env.BUILD_TYPE }}
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # Cache CMake FetchContent downloads
      # Key includes repo name to prevent cache pollution after repo rename
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ github.repository }}-${{ runner.os }}-${{ hashFiles('CMakeLists.txt', 'dsp/CMakeLists.txt', 'plugins/iterum/CMakeLists.txt', 'tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ github.repository }}-${{ runner.os }}-

      # Note: PCH stays enabled on Linux - ccache handles it, and VSTGUI has
      # a missing #include <string> bug that only manifests when PCH is disabled
      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build DSP Tests
        if: needs.detect-changes.outputs.dsp == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --target dsp_tests --parallel

      - name: Build Iterum Tests
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --target plugin_tests approval_tests --parallel

      - name: Build Iterum and Validator
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --target Iterum validator --parallel

      - name: Build Disrumpo
        if: needs.detect-changes.outputs.disrumpo == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: cmake --build build --target Disrumpo --parallel

      - name: Run DSP Tests
        if: needs.detect-changes.outputs.dsp == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "dsp_tests"

      - name: Run Iterum Tests
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "plugin_tests|approval_tests"

      - name: Run VST3 Validator (Iterum)
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      # Show ccache statistics for debugging cache effectiveness
      - name: Show ccache stats
        if: always()
        run: ccache --show-stats

      - name: Upload Iterum Artifact
        if: needs.detect-changes.outputs.iterum == 'true' || needs.detect-changes.outputs.infra == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Linux-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn

      - name: Upload Disrumpo Artifact
        if: needs.detect-changes.outputs.disrumpo == 'true' || needs.detect-changes.outputs.infra == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Disrumpo-Linux-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Disrumpo.vst3
          if-no-files-found: warn
