name: Release

# Manual trigger only
on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Mark as pre-release?'
        type: boolean
        default: false

# Prevent duplicate runs
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # Read version from version.json (single source of truth)
  version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Version
        id: version
        run: |
          VERSION=$(jq -r '.version' version.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION (tag: v$VERSION)"

  # Build and test on all platforms using the CI workflow
  build:
    name: Build & Test
    needs: version
    uses: ./.github/workflows/ci.yml

  # Windows installer using Inno Setup
  windows-installer:
    name: Windows Installer
    needs: [version, build]
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: Iterum-Windows-x64
          path: artifact

      - name: Prepare Installer Files
        run: |
          Copy-Item -Path "artifact\*" -Destination "installers\windows\" -Recurse -Force

      - name: Build Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: installers/windows/setup.iss
          options: /DVersion=${{ needs.version.outputs.version }}

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installers/windows/Iterum-${{ needs.version.outputs.version }}-Windows-x64.exe
          if-no-files-found: error

  # macOS installer using pkgbuild
  macos-installer:
    name: macOS Installer
    needs: [version, build]
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: Iterum-macOS
          path: artifact

      - name: Prepare Installer Files
        run: |
          mkdir -p staging/Library/Audio/Plug-Ins/VST3
          cp -R artifact/Iterum.vst3 staging/Library/Audio/Plug-Ins/VST3/

      - name: Build Installer
        run: |
          pkgbuild \
            --root staging \
            --identifier com.krateaudio.iterum.vst3 \
            --version ${{ needs.version.outputs.version }} \
            --install-location / \
            Iterum-${{ needs.version.outputs.version }}-macOS.pkg

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: Iterum-${{ needs.version.outputs.version }}-macOS.pkg
          if-no-files-found: error

  # Linux archive with README
  linux-archive:
    name: Linux Archive
    needs: [version, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: Iterum-Linux-x64
          path: artifact

      - name: Prepare Archive Files
        run: |
          mkdir -p staging
          cp -R artifact/Iterum.vst3 staging/
          cp installers/linux/README.txt staging/

      - name: Create Archive
        run: |
          cd staging
          tar -czvf ../Iterum-${{ needs.version.outputs.version }}-Linux-x64.tar.gz *

      - name: Upload Archive
        uses: actions/upload-artifact@v4
        with:
          name: linux-archive
          path: Iterum-${{ needs.version.outputs.version }}-Linux-x64.tar.gz
          if-no-files-found: error

  # Create GitHub Release with all installers (creates tag automatically)
  release:
    name: Create Release
    needs: [version, windows-installer, macos-installer, linux-archive]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_url: ${{ steps.release.outputs.url }}

    steps:
      - name: Download Windows Installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: installers

      - name: Download macOS Installer
        uses: actions/download-artifact@v4
        with:
          name: macos-installer
          path: installers

      - name: Download Linux Archive
        uses: actions/download-artifact@v4
        with:
          name: linux-archive
          path: installers

      - name: List Installers
        run: ls -la installers/

      # Create GitHub Release and tag
      - name: Create Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: Iterum ${{ needs.version.outputs.tag }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            installers/Iterum-${{ needs.version.outputs.version }}-Windows-x64.exe
            installers/Iterum-${{ needs.version.outputs.version }}-macOS.pkg
            installers/Iterum-${{ needs.version.outputs.version }}-Linux-x64.tar.gz

  # Deploy landing page to GitHub Pages
  deploy-pages:
    name: Deploy Landing Page
    needs: [version, release]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Metadata
        id: meta
        run: |
          echo "name=$(jq -r '.name' version.json)" >> $GITHUB_OUTPUT
          echo "description=$(jq -r '.description' version.json)" >> $GITHUB_OUTPUT
          echo "publisher=$(jq -r '.publisher' version.json)" >> $GITHUB_OUTPUT
          echo "url=$(jq -r '.url' version.json)" >> $GITHUB_OUTPUT

      - name: Generate Landing Page
        run: |
          mkdir -p _site
          VERSION="${{ needs.version.outputs.version }}"
          TAG="${{ needs.version.outputs.tag }}"
          REPO="${{ github.repository }}"

          # Generate index.html from template
          sed -e "s|{{VERSION}}|$VERSION|g" \
              -e "s|{{TAG}}|$TAG|g" \
              -e "s|{{REPO}}|$REPO|g" \
              -e "s|{{NAME}}|${{ steps.meta.outputs.name }}|g" \
              -e "s|{{DESCRIPTION}}|${{ steps.meta.outputs.description }}|g" \
              -e "s|{{PUBLISHER}}|${{ steps.meta.outputs.publisher }}|g" \
              docs/index.html > _site/index.html

          # Copy assets
          cp -r docs/assets _site/ 2>/dev/null || true

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
